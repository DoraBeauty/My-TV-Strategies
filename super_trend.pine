//@version=5
indicator("SMC Pro Max (Âè∞ÊåáÊúüÂÑ™ÂåñÁâà)", shorttitle="SMC Pro Max (Âè∞ÊåáÊúü)", overlay=true, max_lines_count=500, max_boxes_count=500, max_labels_count=500)

// ==========================================
// 1. ÂèÉÊï∏Ë®≠ÂÆö
// ==========================================
grp_time = "‚è±Ô∏è ÂàÜÊûêÊôÇÊÆµË®≠ÂÆö"
start_time = input.time(timestamp("01 Jan 2024 00:00 +0800"), "ÂàÜÊûêËµ∑ÂßãÊôÇÈñì (Ë´ãÈªûÊìäÂúñË°®)", confirm=true, group=grp_time)

grp_signal = "üïØÔ∏è KÁ∑öÂèçËΩâË®äËôü"
show_pin = input.bool(true, "È°ØÁ§∫ Pinbar (ÊèíÈáù)", group=grp_signal)
show_eng = input.bool(true, "È°ØÁ§∫ Engulfing (ÂêûÂô¨)", group=grp_signal)

grp_smc = "üèõÔ∏è SMC Ê†∏ÂøÉÈ°ØÁ§∫"
show_history = input.bool(true, "È°ØÁ§∫Ê≠∑Âè≤Ë®äËôü (‰øùÁïôËàäÁ∑öÂúñ)", group=grp_smc)
show_bos = input.bool(true, "È°ØÁ§∫ BOS (ÁµêÊßãÁ†¥Â£û)", group=grp_smc)
show_choch = input.bool(true, "È°ØÁ§∫ CHoCH (Ë∂®Âã¢ÂèçËΩâ)", group=grp_smc)
show_ob = input.bool(true, "È°ØÁ§∫ Order Blocks (Ë®ÇÂñÆÂ°ä)", group=grp_smc)
show_fvg = input.bool(true, "È°ØÁ§∫ FVG (Â§±Ë°°ÂçÄ)", group=grp_smc)
show_pd = input.bool(true, "È°ØÁ§∫ P/D ÂçÄÈñì (Ê∫¢ÂÉπ/ÊäòÂÉπ)", group=grp_smc)

grp_trend = "üìà Ë∂®Âã¢ÂèÉÊï∏"
length = input.int(5, "ÁµêÊßãÂÅµÊ∏¨ÈùàÊïèÂ∫¶", minval=2, group=grp_trend)
sma_len = input.int(50, "Ë∂®Âã¢ÂùáÁ∑ö (SMA 50)", group=grp_trend)

grp_new = "‚ú® Êñ∞Â¢ûËºîÂä©ÂäüËÉΩ"
use_ema_filter = input.bool(false, "ÂïüÁî® EMA 200 Ë∂®Âã¢ÊøæÁ∂≤", group=grp_new)
show_div = input.bool(true, "È°ØÁ§∫ RSI ËÉåÈõ¢Ë®äËôü (Div)", group=grp_new)
show_orb = input.bool(true, "È°ØÁ§∫ÈñãÁõ§ÂçÄÈñì (ORB)", group=grp_new)
orb_period = input.int(15, "ORB ÂàÜÈêòÊï∏", minval=1, maxval=60, group=grp_new)
show_mtf = input.bool(true, "È°ØÁ§∫Â§öÈÄ±ÊúüË∂®Âã¢ (MTF)", group=grp_new)

// ==========================================
// 2. Âü∫Á§éÊï∏Êìö
// ==========================================
in_session = time >= start_time
price = close
sma = ta.sma(price, sma_len)
trend_up = price > sma
// ÈÄôË£°‰øÆÊ≠£ÔºöRSI ÂÖ®ÂüüË®àÁÆó
rsi_val = ta.rsi(price, 14)

// EMA 200 ÊøæÁ∂≤
ema200 = ta.ema(close, 200)
trend_bull_ema = close > ema200
trend_bear_ema = close < ema200
bgcolor(use_ema_filter ? (trend_bull_ema ? color.new(color.green, 95) : color.new(color.red, 95)) : na, title="EMA 200 Trend Background")

ph = ta.pivothigh(length, length)
pl = ta.pivotlow(length, length)

// ==========================================
// 3. K Á∑öÂèçËΩâË®äËôü
// ==========================================
body = math.abs(close - open)
upper_wick = high - math.max(close, open)
lower_wick = math.min(close, open) - low
candle_range = high - low
avg_range = ta.atr(14)

// Pinbar
is_bull_pin = show_pin and in_session and (lower_wick > body * 2) and (lower_wick > upper_wick) and (candle_range > avg_range * 0.5)
is_bear_pin = show_pin and in_session and (upper_wick > body * 2) and (upper_wick > lower_wick) and (candle_range > avg_range * 0.5)

// Engulfing
is_bull_eng = show_eng and in_session and (close > open) and (close[1] < open[1]) and (close > open[1]) and (open < close[1]) and (candle_range > avg_range * 0.5)
is_bear_eng = show_eng and in_session and (close < open) and (close[1] > open[1]) and (close < open[1]) and (open > close[1]) and (candle_range > avg_range * 0.5)

plotshape(is_bull_pin, title="Bullish Pin", style=shape.labelup, location=location.belowbar, color=color.green, text="Pin", textcolor=color.white, size=size.tiny)
plotshape(is_bear_pin, title="Bearish Pin", style=shape.labeldown, location=location.abovebar, color=color.red, text="Pin", textcolor=color.white, size=size.tiny)
plotshape(is_bull_eng, title="Bull Eng", style=shape.triangleup, location=location.belowbar, color=color.green, text="Eng", textcolor=color.green, size=size.small)
plotshape(is_bear_eng, title="Bear Eng", style=shape.triangledown, location=location.abovebar, color=color.red, text="Eng", textcolor=color.red, size=size.small)

// RSI Divergence
p_lb = 5
src_rsi = rsi_val

// Calculate Lowest/Highest outside of if condition to fix warnings
low_min_30 = ta.lowest(low, 30)
rsi_min_30 = ta.lowest(src_rsi, 30)
high_max_30 = ta.highest(high, 30)
rsi_max_30 = ta.highest(src_rsi, 30)

// Bullish Divergence
bull_div = false
if show_div and in_session
    // Price Lower Low but RSI Higher Low
    price_ll = low[p_lb] < low_min_30[p_lb + 1]
    rsi_hl = src_rsi[p_lb] > rsi_min_30[p_lb + 1]
    if price_ll and rsi_hl and low[p_lb] < low
        bull_div := true

// Bearish Divergence
bear_div = false
if show_div and in_session
    // Price Higher High but RSI Lower High
    price_hh = high[p_lb] > high_max_30[p_lb + 1]
    rsi_lh = src_rsi[p_lb] < rsi_max_30[p_lb + 1]
    if price_hh and rsi_lh and high[p_lb] > high
        bear_div := true

plotshape(bull_div, title="Bull Div", style=shape.labelup, location=location.belowbar, color=color.blue, text="Div", textcolor=color.white, size=size.tiny, offset=-p_lb)
plotshape(bear_div, title="Bear Div", style=shape.labeldown, location=location.abovebar, color=color.orange, text="Div", textcolor=color.white, size=size.tiny, offset=-p_lb)

// ==========================================
// 4. SMC ÁµêÊßã (BOS/CHoCH)
// ==========================================
var float upper = na
var float lower = na
var line up_line = na
var line low_line = na
var int trend = 0 

// Ê≠∑Âè≤Ë®äËôüÁÆ°ÁêÜÈô£Âàó
var line[] arr_bos_lines = array.new_line()
var label[] arr_bos_labels = array.new_label()
var box[] arr_ob_boxes = array.new_box()
var box[] arr_fvg_boxes = array.new_box()

if not na(ph) and in_session
    upper := ph
    up_line := line.new(bar_index - length, ph, bar_index, ph, color=color.gray, style=line.style_dotted)
    line.delete(up_line[1])

if not na(pl) and in_session
    lower := pl
    low_line := line.new(bar_index - length, pl, bar_index, pl, color=color.gray, style=line.style_dotted)
    line.delete(low_line[1])

bool signal_bull = false
bool signal_bear = false

// ÊøæÁ∂≤Ê¢ù‰ª∂ÔºöÂ¶ÇÊûúÂïüÁî®ÊøæÁ∂≤ÔºåÂøÖÈ†àÁ¨¶ÂêàË∂®Âã¢ÔºõÂê¶Ââá (Êú™ÂïüÁî®) ÁÇ∫ true
filter_long = not use_ema_filter or trend_bull_ema
filter_short = not use_ema_filter or trend_bear_ema

if ta.crossover(close, upper) and in_session
    // Âè™ÊúâÁ¨¶ÂêàÊøæÁ∂≤ÊâçÊ®ôÁ§∫
    if filter_long
        string txt = trend == -1 ? "CHoCH" : "BOS"
        color col = color.green
        if show_bos or (show_choch and trend == -1)
            lbl = label.new(bar_index, high, txt, color=col, textcolor=color.white, style=label.style_label_down, size=size.tiny)
            ln = line.new(bar_index, close, bar_index, upper, color=col)

            // Ê≠∑Âè≤ÁÆ°ÁêÜ
            array.push(arr_bos_labels, lbl)
            array.push(arr_bos_lines, ln)
            if not show_history and array.size(arr_bos_labels) > 5
                label.delete(array.shift(arr_bos_labels))
                line.delete(array.shift(arr_bos_lines))

        trend := 1
        signal_bull := true

if ta.crossunder(close, lower) and in_session
    // Âè™ÊúâÁ¨¶ÂêàÊøæÁ∂≤ÊâçÊ®ôÁ§∫
    if filter_short
        string txt = trend == 1 ? "CHoCH" : "BOS"
        color col = color.red
        if show_bos or (show_choch and trend == 1)
            lbl = label.new(bar_index, low, txt, color=col, textcolor=color.white, style=label.style_label_up, size=size.tiny)
            ln = line.new(bar_index, close, bar_index, lower, color=col)

            // Ê≠∑Âè≤ÁÆ°ÁêÜ
            array.push(arr_bos_labels, lbl)
            array.push(arr_bos_lines, ln)
            if not show_history and array.size(arr_bos_labels) > 5
                label.delete(array.shift(arr_bos_labels))
                line.delete(array.shift(arr_bos_lines))

        trend := -1
        signal_bear := true

// ==========================================
// 5. Order Blocks
// ==========================================
if show_ob and in_session
    if signal_bull
        for i = 1 to 10
            if close[i] < open[i]
                b = box.new(bar_index[i], high[i], bar_index + 10, low[i], border_color=na, bgcolor=color.new(color.green, 70), text="Bull OB", text_color=color.white, text_size=size.tiny)
                array.push(arr_ob_boxes, b)
                if not show_history and array.size(arr_ob_boxes) > 5
                    box.delete(array.shift(arr_ob_boxes))
                break
    if signal_bear
        for i = 1 to 10
            if close[i] > open[i]
                b = box.new(bar_index[i], high[i], bar_index + 10, low[i], border_color=na, bgcolor=color.new(color.red, 70), text="Bear OB", text_color=color.white, text_size=size.tiny)
                array.push(arr_ob_boxes, b)
                if not show_history and array.size(arr_ob_boxes) > 5
                    box.delete(array.shift(arr_ob_boxes))
                break

// ==========================================
// 6. FVG
// ==========================================
if show_fvg and in_session
    if high[2] < low[0]
        b = box.new(bar_index[2], low[0], bar_index + 5, high[2], border_color=na, bgcolor=color.new(color.green, 85))
        array.push(arr_fvg_boxes, b)
        if not show_history and array.size(arr_fvg_boxes) > 5
            box.delete(array.shift(arr_fvg_boxes))

    if low[2] > high[0]
        b = box.new(bar_index[2], low[2], bar_index + 5, high[0], border_color=na, bgcolor=color.new(color.red, 85))
        array.push(arr_fvg_boxes, b)
        if not show_history and array.size(arr_fvg_boxes) > 5
            box.delete(array.shift(arr_fvg_boxes))

// ==========================================
// 7. P/D Zones
// ==========================================
if show_pd and in_session and not na(upper) and not na(lower)
    mid = math.avg(upper, lower)
    line.new(bar_index - 10, mid, bar_index + 5, mid, color=color.gray, style=line.style_dashed)
    if barstate.islast
        box.new(bar_index, mid, bar_index + 5, upper, bgcolor=color.new(color.red, 90), border_color=na)
        box.new(bar_index, lower, bar_index + 5, mid, bgcolor=color.new(color.green, 90), border_color=na)

// ==========================================
// 8. ÈñãÁõ§ÂçÄÈñì (ORB) - Âè∞ÊåáÊúüÂ∞àÁî®
// ==========================================
var float orb_high = na
var float orb_low = na
var line orb_h_line = na
var line orb_l_line = na
var box orb_box = na

// ÂÅµÊ∏¨ÈñãÁõ§Á¨¨‰∏ÄÊ†πKÊ£í (ÈÄôË£°ÂÅáË®≠ start_time Ë®≠ÂÆöÊ≠£Á¢∫ÔºåÊàñÊØèÊó•ÈáçÁΩÆ)
// ÁÇ∫‰∫ÜÁ∞°ÂñÆËµ∑Ë¶ãÔºåÊàëÂÄëÂÅµÊ∏¨ session ÁöÑÈñãÂßã„ÄÇ
// Âè∞ÊåáÊúüÊó•Áõ§ 08:45ÔºåÂ§úÁõ§ 15:00„ÄÇÊàëÂÄëÂèØ‰ª•Áî® time(timeframe.period, "0845-0900:1234567") ÈÄôÁ®ÆÊñπÂºèÔºå‰ΩÜÊúÄÁ∞°ÂñÆÊòØ‰æùË≥¥ session ËÆäÊèõ
is_session_time = not na(time(timeframe.period, "0845-1345:1234567"))
if timeframe.isintraday and show_orb
    // ÊØèÊó•ÈáçÁΩÆ
    if ta.change(time("D"))
        orb_high := na
        orb_low := na
        orb_h_line := na
        orb_l_line := na
        orb_box := na

    // Ë®àÁÆóÂçÄÈñì
    // ÂèñÂæóÈñãÁõ§Âæå orb_period ÂàÜÈêòÂÖßÁöÑÊúÄÈ´òÊúÄ‰Ωé
    // Áî±Êñº Pine Script ËôïÁêÜÊôÇÈñìËºÉË§áÈõúÔºåÈÄôË£°‰ΩøÁî® session ÊôÇÈñìÈÅéÊøæ
    // Á∞°ÂñÆÈÇèËºØÔºöÂ¶ÇÊûúÁï∂ÂâçÊôÇÈñìÂú® "0845" + orb_period ÂàÜÈêòÂÖßÔºåÊåÅÁ∫åÊõ¥Êñ∞ orb_high/low

    // Ë®àÁÆóÁï∂Êó•ÂàÜÈêòÊï∏
    t_min = hour(time) * 60 + minute(time)
    start_min = 8 * 60 + 45 // 08:45 = 525
    end_orb_min = start_min + orb_period

    if t_min >= start_min and t_min < end_orb_min
        if na(orb_high)
            orb_high := high
            orb_low := low
        else
            orb_high := math.max(orb_high, high)
            orb_low := math.min(orb_low, low)

    // Áπ™Ë£ΩÁ∑öÊ¢ù
    if t_min == end_orb_min and not na(orb_high)
        orb_h_line := line.new(bar_index, orb_high, bar_index + 10, orb_high, color=color.blue, style=line.style_dashed)
        orb_l_line := line.new(bar_index, orb_low, bar_index + 10, orb_low, color=color.blue, style=line.style_dashed)
        orb_box := box.new(bar_index - 10, orb_high, bar_index + 10, orb_low, bgcolor=color.new(color.blue, 95), border_color=na)

    // Âª∂Èï∑Á∑öÊ¢ù
    if not na(orb_h_line)
        line.set_x2(orb_h_line, bar_index)
        line.set_x2(orb_l_line, bar_index)
        box.set_right(orb_box, bar_index)

// ==========================================
// 9. ÂÑÄË°®Êùø (Â∑≤‰øÆÂæ©ÈåØË™§)
// ==========================================
d_high = request.security(syminfo.tickerid, "D", high)
d_low = request.security(syminfo.tickerid, "D", low)
atr_val = ta.atr(14)

// MTF Trends
// Function to get trend from other timeframes (Price > EMA 50)
get_trend(tf) =>
    cl = request.security(syminfo.tickerid, tf, close)
    em = request.security(syminfo.tickerid, tf, ta.ema(close, 50))
    cl > em

t_15m = get_trend("15")
t_60m = get_trend("60")
t_240m = get_trend("240")

// Table Size: Increased rows to accommodate MTF if enabled
rows_count = show_mtf ? 11 : 8
var table dash = table.new(position.top_right, 2, rows_count, bgcolor = color.new(color.black, 50), border_color = color.gray, border_width = 1, frame_color = color.gray, frame_width = 1)

if barstate.islast
    // Header
    table.cell(dash, 0, 0, "SMC Pro Max", text_color=color.white, bgcolor=color.new(color.blue, 20), text_size=size.small)
    table.merge_cells(dash, 0, 0, 1, 0)

    // Structure
    string mkt_struct = trend == 1 ? "Â§öÈ†≠ÁµêÊßã" : "Á©∫È†≠ÁµêÊßã"
    color mkt_col = trend == 1 ? color.green : color.red
    table.cell(dash, 0, 1, "ÁµêÊßãÊñπÂêë", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 1, mkt_struct, text_color=mkt_col, text_halign=text.align_right, text_size=size.small)

    // RSI
    table.cell(dash, 0, 2, "RSI ÂãïËÉΩ", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 2, str.tostring(rsi_val, "#.##"), text_color=rsi_val > 50 ? color.green : color.red, text_halign=text.align_right, text_size=size.small)
    
    // P/D
    float u = na(upper) ? high : upper
    float l = na(lower) ? low : lower
    string pd_txt = close > math.avg(u, l) ? "Ê∫¢ÂÉπÂçÄ (Ë≥£)" : "ÊäòÂÉπÂçÄ (Ë≤∑)"
    color pd_col = close > math.avg(u, l) ? color.red : color.green
    table.cell(dash, 0, 3, "P/D ‰ΩçÁΩÆ", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 3, pd_txt, text_color=pd_col, text_halign=text.align_right, text_size=size.small)
    
    // Daily Stats
    table.cell(dash, 0, 4, "‰ªäÊó•ÊúÄÈ´ò", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 4, str.tostring(d_high), text_color=color.green, text_halign=text.align_right, text_size=size.small)

    table.cell(dash, 0, 5, "‰ªäÊó•ÊúÄ‰Ωé", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 5, str.tostring(d_low), text_color=color.red, text_halign=text.align_right, text_size=size.small)

    table.cell(dash, 0, 6, "ATR Ê≥¢Âãï", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 6, str.tostring(atr_val, "#.##"), text_color=color.yellow, text_halign=text.align_right, text_size=size.small)

    table.cell(dash, 0, 7, "ÁèæÂÉπ", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 7, str.tostring(close), text_color=color.white, text_halign=text.align_right, text_size=size.small)

    // MTF Section
    if show_mtf
        table.cell(dash, 0, 8, "15ÂàÜ Ë∂®Âã¢", text_color=color.white, text_halign=text.align_left, text_size=size.small)
        table.cell(dash, 1, 8, t_15m ? "Â§ö" : "Á©∫", text_color=t_15m ? color.green : color.red, text_halign=text.align_right, text_size=size.small)

        table.cell(dash, 0, 9, "60ÂàÜ Ë∂®Âã¢", text_color=color.white, text_halign=text.align_left, text_size=size.small)
        table.cell(dash, 1, 9, t_60m ? "Â§ö" : "Á©∫", text_color=t_60m ? color.green : color.red, text_halign=text.align_right, text_size=size.small)

        table.cell(dash, 0, 10, "4H Ë∂®Âã¢", text_color=color.white, text_halign=text.align_left, text_size=size.small)
        table.cell(dash, 1, 10, t_240m ? "Â§ö" : "Á©∫", text_color=t_240m ? color.green : color.red, text_halign=text.align_right, text_size=size.small)

bgcolor(in_session ? color.new(color.blue, 97) : na)
