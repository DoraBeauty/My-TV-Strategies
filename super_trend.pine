//@version=5
indicator("SMC Pro Max (Âè∞ÊåáÊúüÂÑ™ÂåñÁâà)", shorttitle="SMC Pro Max (Âè∞ÊåáÊúü)", overlay=true, max_lines_count=500, max_boxes_count=500, max_labels_count=500)

// ==========================================
// 1. ÂèÉÊï∏Ë®≠ÂÆö
// ==========================================
grp_time = "‚è±Ô∏è ÂàÜÊûêÊôÇÊÆµË®≠ÂÆö"
start_time = input.time(timestamp("01 Jan 2024 00:00 +0800"), "ÂàÜÊûêËµ∑ÂßãÊôÇÈñì (Ë´ãÈªûÊìäÂúñË°®)", confirm=true, group=grp_time)

grp_signal = "üïØÔ∏è KÁ∑öÂèçËΩâË®äËôü"
show_pin = input.bool(true, "È°ØÁ§∫ Pinbar (ÊèíÈáù)", group=grp_signal)
show_eng = input.bool(true, "È°ØÁ§∫ Engulfing (ÂêûÂô¨)", group=grp_signal)

grp_smc = "üèõÔ∏è SMC Ê†∏ÂøÉÈ°ØÁ§∫"
show_history = input.bool(true, "È°ØÁ§∫Ê≠∑Âè≤Ë®äËôü (‰øùÁïôËàäÁ∑öÂúñ)", group=grp_smc)
show_bos = input.bool(true, "È°ØÁ§∫ BOS (ÁµêÊßãÁ†¥Â£û)", group=grp_smc)
show_choch = input.bool(true, "È°ØÁ§∫ CHoCH (Ë∂®Âã¢ÂèçËΩâ)", group=grp_smc)
show_ob = input.bool(true, "È°ØÁ§∫ Order Blocks (Ë®ÇÂñÆÂ°ä)", group=grp_smc)
show_fvg = input.bool(true, "È°ØÁ§∫ FVG (Â§±Ë°°ÂçÄ)", group=grp_smc)
show_pd = input.bool(true, "È°ØÁ§∫ P/D ÂçÄÈñì (Ê∫¢ÂÉπ/ÊäòÂÉπ)", group=grp_smc)

grp_trend = "üìà Ë∂®Âã¢ÂèÉÊï∏"
length = input.int(5, "ÁµêÊßãÂÅµÊ∏¨ÈùàÊïèÂ∫¶", minval=2, group=grp_trend)
sma_len = input.int(50, "Ë∂®Âã¢ÂùáÁ∑ö (SMA 50)", group=grp_trend)

// ==========================================
// 2. Âü∫Á§éÊï∏Êìö
// ==========================================
in_session = time >= start_time
price = close
sma = ta.sma(price, sma_len)
trend_up = price > sma
// ÈÄôË£°‰øÆÊ≠£ÔºöRSI ÂÖ®ÂüüË®àÁÆó
rsi_val = ta.rsi(price, 14)

ph = ta.pivothigh(length, length)
pl = ta.pivotlow(length, length)

// ==========================================
// 3. K Á∑öÂèçËΩâË®äËôü
// ==========================================
body = math.abs(close - open)
upper_wick = high - math.max(close, open)
lower_wick = math.min(close, open) - low
candle_range = high - low
avg_range = ta.atr(14)

// Pinbar
is_bull_pin = show_pin and in_session and (lower_wick > body * 2) and (lower_wick > upper_wick) and (candle_range > avg_range * 0.5)
is_bear_pin = show_pin and in_session and (upper_wick > body * 2) and (upper_wick > lower_wick) and (candle_range > avg_range * 0.5)

// Engulfing
is_bull_eng = show_eng and in_session and (close > open) and (close[1] < open[1]) and (close > open[1]) and (open < close[1]) and (candle_range > avg_range * 0.5)
is_bear_eng = show_eng and in_session and (close < open) and (close[1] > open[1]) and (close < open[1]) and (open > close[1]) and (candle_range > avg_range * 0.5)

plotshape(is_bull_pin, title="Bullish Pin", style=shape.labelup, location=location.belowbar, color=color.green, text="Pin", textcolor=color.white, size=size.tiny)
plotshape(is_bear_pin, title="Bearish Pin", style=shape.labeldown, location=location.abovebar, color=color.red, text="Pin", textcolor=color.white, size=size.tiny)
plotshape(is_bull_eng, title="Bull Eng", style=shape.triangleup, location=location.belowbar, color=color.green, text="Eng", textcolor=color.green, size=size.small)
plotshape(is_bear_eng, title="Bear Eng", style=shape.triangledown, location=location.abovebar, color=color.red, text="Eng", textcolor=color.red, size=size.small)

// ==========================================
// 4. SMC ÁµêÊßã (BOS/CHoCH)
// ==========================================
var float upper = na
var float lower = na
var line up_line = na
var line low_line = na
var int trend = 0 

// Ê≠∑Âè≤Ë®äËôüÁÆ°ÁêÜÈô£Âàó
var line[] arr_bos_lines = array.new_line()
var label[] arr_bos_labels = array.new_label()
var box[] arr_ob_boxes = array.new_box()
var box[] arr_fvg_boxes = array.new_box()

if not na(ph) and in_session
    upper := ph
    up_line := line.new(bar_index - length, ph, bar_index, ph, color=color.gray, style=line.style_dotted)
    line.delete(up_line[1])

if not na(pl) and in_session
    lower := pl
    low_line := line.new(bar_index - length, pl, bar_index, pl, color=color.gray, style=line.style_dotted)
    line.delete(low_line[1])

bool signal_bull = false
bool signal_bear = false

if ta.crossover(close, upper) and in_session
    string txt = trend == -1 ? "CHoCH" : "BOS"
    color col = color.green
    if show_bos or (show_choch and trend == -1)
        lbl = label.new(bar_index, high, txt, color=col, textcolor=color.white, style=label.style_label_down, size=size.tiny)
        ln = line.new(bar_index, close, bar_index, upper, color=col)

        // Ê≠∑Âè≤ÁÆ°ÁêÜ
        array.push(arr_bos_labels, lbl)
        array.push(arr_bos_lines, ln)
        if not show_history and array.size(arr_bos_labels) > 5
            label.delete(array.shift(arr_bos_labels))
            line.delete(array.shift(arr_bos_lines))

    trend := 1
    signal_bull := true

if ta.crossunder(close, lower) and in_session
    string txt = trend == 1 ? "CHoCH" : "BOS"
    color col = color.red
    if show_bos or (show_choch and trend == 1)
        lbl = label.new(bar_index, low, txt, color=col, textcolor=color.white, style=label.style_label_up, size=size.tiny)
        ln = line.new(bar_index, close, bar_index, lower, color=col)

        // Ê≠∑Âè≤ÁÆ°ÁêÜ
        array.push(arr_bos_labels, lbl)
        array.push(arr_bos_lines, ln)
        if not show_history and array.size(arr_bos_labels) > 5
            label.delete(array.shift(arr_bos_labels))
            line.delete(array.shift(arr_bos_lines))

    trend := -1
    signal_bear := true

// ==========================================
// 5. Order Blocks
// ==========================================
if show_ob and in_session
    if signal_bull
        for i = 1 to 10
            if close[i] < open[i]
                b = box.new(bar_index[i], high[i], bar_index + 10, low[i], border_color=na, bgcolor=color.new(color.green, 70), text="Bull OB", text_color=color.white, text_size=size.tiny)
                array.push(arr_ob_boxes, b)
                if not show_history and array.size(arr_ob_boxes) > 5
                    box.delete(array.shift(arr_ob_boxes))
                break
    if signal_bear
        for i = 1 to 10
            if close[i] > open[i]
                b = box.new(bar_index[i], high[i], bar_index + 10, low[i], border_color=na, bgcolor=color.new(color.red, 70), text="Bear OB", text_color=color.white, text_size=size.tiny)
                array.push(arr_ob_boxes, b)
                if not show_history and array.size(arr_ob_boxes) > 5
                    box.delete(array.shift(arr_ob_boxes))
                break

// ==========================================
// 6. FVG
// ==========================================
if show_fvg and in_session
    if high[2] < low[0]
        b = box.new(bar_index[2], low[0], bar_index + 5, high[2], border_color=na, bgcolor=color.new(color.green, 85))
        array.push(arr_fvg_boxes, b)
        if not show_history and array.size(arr_fvg_boxes) > 5
            box.delete(array.shift(arr_fvg_boxes))

    if low[2] > high[0]
        b = box.new(bar_index[2], low[2], bar_index + 5, high[0], border_color=na, bgcolor=color.new(color.red, 85))
        array.push(arr_fvg_boxes, b)
        if not show_history and array.size(arr_fvg_boxes) > 5
            box.delete(array.shift(arr_fvg_boxes))

// ==========================================
// 7. P/D Zones
// ==========================================
if show_pd and in_session and not na(upper) and not na(lower)
    mid = math.avg(upper, lower)
    line.new(bar_index - 10, mid, bar_index + 5, mid, color=color.gray, style=line.style_dashed)
    if barstate.islast
        box.new(bar_index, mid, bar_index + 5, upper, bgcolor=color.new(color.red, 90), border_color=na)
        box.new(bar_index, lower, bar_index + 5, mid, bgcolor=color.new(color.green, 90), border_color=na)

// ==========================================
// 8. ÂÑÄË°®Êùø (Â∑≤‰øÆÂæ©ÈåØË™§)
// ==========================================
d_high = request.security(syminfo.tickerid, "D", high)
d_low = request.security(syminfo.tickerid, "D", low)
atr_val = ta.atr(14)

var table dash = table.new(position.top_right, 2, 8, bgcolor = color.new(color.black, 50), border_color = color.gray, border_width = 1, frame_color = color.gray, frame_width = 1)

if barstate.islast
    // ‚òÖ ‰øÆÊ≠£ËôïÔºöÁßªÈô§ merge_cells ÂèÉÊï∏ÔºåÊîπÁî®Áç®Á´ãÂáΩÊï∏
    table.cell(dash, 0, 0, "SMC Pro Max", text_color=color.white, bgcolor=color.new(color.blue, 20), text_size=size.small)
    table.merge_cells(dash, 0, 0, 1, 0) // <--- Ê≠£Á¢∫Âêà‰ΩµÊñπÂºè

    string mkt_struct = trend == 1 ? "Â§öÈ†≠ÁµêÊßã" : "Á©∫È†≠ÁµêÊßã"
    color mkt_col = trend == 1 ? color.green : color.red
    table.cell(dash, 0, 1, "ÁµêÊßãÊñπÂêë", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 1, mkt_struct, text_color=mkt_col, text_halign=text.align_right, text_size=size.small)

    table.cell(dash, 0, 2, "RSI ÂãïËÉΩ", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 2, str.tostring(rsi_val, "#.##"), text_color=rsi_val > 50 ? color.green : color.red, text_halign=text.align_right, text_size=size.small)
    
    float u = na(upper) ? high : upper
    float l = na(lower) ? low : lower
    string pd_txt = close > math.avg(u, l) ? "Ê∫¢ÂÉπÂçÄ (Ë≥£)" : "ÊäòÂÉπÂçÄ (Ë≤∑)"
    color pd_col = close > math.avg(u, l) ? color.red : color.green
    table.cell(dash, 0, 3, "P/D ‰ΩçÁΩÆ", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 3, pd_txt, text_color=pd_col, text_halign=text.align_right, text_size=size.small)
    
    table.cell(dash, 0, 4, "‰ªäÊó•ÊúÄÈ´ò", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 4, str.tostring(d_high), text_color=color.green, text_halign=text.align_right, text_size=size.small)

    table.cell(dash, 0, 5, "‰ªäÊó•ÊúÄ‰Ωé", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 5, str.tostring(d_low), text_color=color.red, text_halign=text.align_right, text_size=size.small)

    table.cell(dash, 0, 6, "ATR Ê≥¢Âãï", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 6, str.tostring(atr_val, "#.##"), text_color=color.yellow, text_halign=text.align_right, text_size=size.small)

    table.cell(dash, 0, 7, "ÁèæÂÉπ", text_color=color.white, text_halign=text.align_left, text_size=size.small)
    table.cell(dash, 1, 7, str.tostring(close), text_color=color.white, text_halign=text.align_right, text_size=size.small)

bgcolor(in_session ? color.new(color.blue, 97) : na)
